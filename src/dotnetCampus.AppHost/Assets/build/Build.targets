<Project>

  <PropertyGroup>
    <MSBuildAllProjects>$(MSBuildAllProjects);$(MSBuildThisFileFullPath)</MSBuildAllProjects>
  </PropertyGroup>

  <PropertyGroup>
    <_DCTargetFramework Condition="'$(TargetFramework)'=='net6.0'">net6.0</_DCTargetFramework>
    <_DCTargetFramework Condition="'$(TargetFramework)'=='net6.0-windows'">net6.0</_DCTargetFramework>
    <!-- 暂时还没有支持 net5.0。 -->
    <!--<_DCTargetFramework Condition="'$(TargetFramework)'=='net5.0'">net5.0</_DCTargetFramework>-->
    <!--<_DCTargetFramework Condition="'$(TargetFramework)'=='net5.0-windows'">net5.0</_DCTargetFramework>-->
  </PropertyGroup>

  <Target Name="CreateCustomAppHost" BeforeTargets="_CreateAppHost" DependsOnTargets="_ChooseAppHost">

    <PropertyGroup>
      <_DCAppHostRoot>$(MSBuildThisFileDirectory)..\</_DCAppHostRoot>
      <DCAppHostPatcherToolPath Condition="$(DCAppHostPatcherToolPath)==''">$(_DCAppHostRoot)tools\dotnetCampus.AppHost.dll</DCAppHostPatcherToolPath>
      <_DCAppHostPatcherTool Condition="$(DCAppHostPatcherToolPath.EndsWith('.dll'))">dotnet $(DCAppHostPatcherToolPath)</_DCAppHostPatcherTool>
      <_DCAppHostPatcherTool Condition="$(_DCAppHostPatcherTool)==''">$(DCAppHostPatcherToolPath)</_DCAppHostPatcherTool>
      <_DCAppHostSourceDirectory>$(_DCAppHostRoot)template\$(_DCTargetFramework)\$(DefaultAppHostRuntimeIdentifier)\</_DCAppHostSourceDirectory>
      <_DCAppHostTempTargetDirectory>$(IntermediateOutputPath)dotnetCampus.AppHost\</_DCAppHostTempTargetDirectory>
    </PropertyGroup>

    <Error Condition="!Exists($(DCAppHostPatcherToolPath))" Text="工具路径 “$(DCAppHostPatcherToolPath)” 不存在，命令 $(_DCAppHostPatcherTool)。" />
    <Error Condition="$(DCAppHostDotnetRoot)!='' and $(_DCTargetFramework)==''" Text="不支持为 $(TargetFramework) 框架修改 AppHost。" />
    <Error Condition="$(DCAppHostDotnetRoot)!='' and !Exists('$(_DCAppHostSourceDirectory)') " Text="不支持为（$(DefaultAppHostRuntimeIdentifier)）运行时修改 AppHost。" />

    <Message Importance="high" Condition="$(DCAppHostDotnetRoot)==''" Text="项目 $(MSBuildProjectName) 没有为框架 $(TargetFramework) 和运行时 $(DefaultAppHostRuntimeIdentifier) 指定 DCAppHostDotnetRoot，因此不会自定义 AppHost 的 dotnet_root 路径。" />
    <Message Importance="high" Condition="$(DCAppHostDotnetRoot)!=''" Text="项目 $(MSBuildProjectName) 已为框架 $(TargetFramework) 和运行时 $(DefaultAppHostRuntimeIdentifier) 指定的自定义 AppHost dotnet_root 路径为 $(DCAppHostDotnetRoot)。" />

    <PropertyGroup>
      <_DCAppHostSourceFile>$(_DCAppHostSourceDirectory)apphost.exe</_DCAppHostSourceFile>
      <_DCAppHostTempTargetFile>$(_DCAppHostTempTargetDirectory)apphost.exe</_DCAppHostTempTargetFile>
    </PropertyGroup>

    <Copy Condition="$(DCAppHostDotnetRoot)!=''" SourceFiles="$(_DCAppHostSourceFile)" DestinationFiles="$(_DCAppHostTempTargetFile)" />
    <Exec Condition="$(DCAppHostDotnetRoot)!=''" Command="$(_DCAppHostPatcherTool) $(_DCAppHostTempTargetFile) -d $(DCAppHostDotnetRoot)"
          IgnoreExitCode="false">
      <Output TaskParameter="ExitCode" PropertyName="_DCAppHostPatcherExitCode" />
    </Exec>

    <PropertyGroup Condition=" $(DCAppHostDotnetRoot) != '' ">
      <AppHostSourcePath Condition="$(DCAppHostDotnetRoot)!=''">$(_DCAppHostTempTargetFile)</AppHostSourcePath>
    </PropertyGroup>

  </Target>

</Project>