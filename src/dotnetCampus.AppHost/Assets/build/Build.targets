<Project>

  <PropertyGroup>
    <MSBuildAllProjects>$(MSBuildAllProjects);$(MSBuildThisFileFullPath)</MSBuildAllProjects>
  </PropertyGroup>

  <PropertyGroup>
    <_DCTargetFramework Condition="'$(TargetFramework)'=='net6.0'">net6.0</_DCTargetFramework>
    <_DCTargetFramework Condition="'$(TargetFramework)'=='net6.0-windows'">net6.0</_DCTargetFramework>
    <!-- 暂时还没有支持 net5.0。 -->
    <!--<_DCTargetFramework Condition="'$(TargetFramework)'=='net5.0'">net5.0</_DCTargetFramework>-->
    <!--<_DCTargetFramework Condition="'$(TargetFramework)'=='net5.0-windows'">net5.0</_DCTargetFramework>-->
  </PropertyGroup>

  <Target Name="CreateCustomAppHost" BeforeTargets="_CreateAppHost" DependsOnTargets="_ChooseAppHost">

    <PropertyGroup>
      <_DCAppHostRoot>$(MSBuildThisFileDirectory)..\</_DCAppHostRoot>
      <DCAppHostPatcherToolPath Condition="$(DCAppHostPatcherToolPath)==''">$(_DCAppHostRoot)tools\dotnetCampus.AppHost.dll</DCAppHostPatcherToolPath>
      <_DCAppHostPatcherTool Condition="$(DCAppHostPatcherToolPath.EndsWith('.dll'))">dotnet $(DCAppHostPatcherToolPath)</_DCAppHostPatcherTool>
      <_DCAppHostPatcherTool Condition="$(_DCAppHostPatcherTool)==''">$(DCAppHostPatcherToolPath)</_DCAppHostPatcherTool>
      <_DCAppHostSourceDirectory>$(_DCAppHostRoot)template\$(_DCTargetFramework)\$(DefaultAppHostRuntimeIdentifier)\</_DCAppHostSourceDirectory>
      <_DCAppHostTempTargetDirectory>$(IntermediateOutputPath)dotnetCampus.AppHost\</_DCAppHostTempTargetDirectory>
      <_DCAppHostOptionFilePath>$(IntermediateOutputPath)dotnetCampus.AppHost\Options.txt</_DCAppHostOptionFilePath>
    </PropertyGroup>

    <PropertyGroup>
      <_DCAppHostWillBeChanged>false</_DCAppHostWillBeChanged>
      <_DCAppHostWillBeChanged Condition="$(_DCAppHostTempTargetFile)!='' or $(DCCoreHostLibMissingDialogMessage)!='' or $(DCCoreHostLibMissingDialogUrl)!='' or $(DCSystemNeedPrereqsMessage)!='' or $(DCSystemNeedPrereqsUrl)!=''">true</_DCAppHostWillBeChanged>
    </PropertyGroup>

    <Error Condition="!Exists($(DCAppHostPatcherToolPath))" Text="工具路径 “$(DCAppHostPatcherToolPath)” 不存在，命令 $(_DCAppHostPatcherTool)。" />
    <Error Condition="$(_DCAppHostWillBeChanged)==true and $(_DCTargetFramework)==''" Text="不支持为 $(TargetFramework) 框架修改 AppHost。" />
    <Error Condition="$(_DCAppHostWillBeChanged)==true and !Exists('$(_DCAppHostSourceDirectory)')" Text="不支持为（$(DefaultAppHostRuntimeIdentifier)）运行时修改 AppHost。" />
    <Error Condition="$(DCSystemNeedPrereqsMessage)!='' and $(DCSystemNeedPrereqsUrl)==''" Text="设置了 DCSystemNeedPrereqsMessage 后，必须也设置 DCSystemNeedPrereqsUrl，因为它没有默认值。" />
    <Error Condition="$(DCSystemNeedPrereqsMessage)=='' and $(DCSystemNeedPrereqsUrl)!=''" Text="设置了 DCSystemNeedPrereqsUrl 后，必须也设置 DCSystemNeedPrereqsMessage，因为它没有默认值。" />

    <Message Importance="high" Condition="$(_DCAppHostWillBeChanged)!=true" Text="项目 $(MSBuildProjectName) 没有为框架 $(TargetFramework) 和运行时 $(DefaultAppHostRuntimeIdentifier) 设置任何 AppHost 相关属性，因此不会修改 AppHost。" />
    <Message Importance="high" Condition="$(_DCAppHostWillBeChanged)==true" Text="项目 $(MSBuildProjectName) 已为框架 $(TargetFramework) 和运行时 $(DefaultAppHostRuntimeIdentifier) 设置自定义的 AppHost 属性：
.NET 运行时路径：$(DCAppHostDotnetRoot)
.NET 运行时缺失提示：$(DCCoreHostLibMissingDialogMessage)
.NET 运行时缺失 URL：$(DCCoreHostLibMissingDialogUrl)
系统不支持运行 .NET 提示：$(DCSystemNeedPrereqsMessage)
系统不支持运行 .NET URL：$(DCSystemNeedPrereqsUrl)" />

    <PropertyGroup>
      <_DCAppHostSourceFile>$(_DCAppHostSourceDirectory)apphost.exe</_DCAppHostSourceFile>
      <_DCAppHostTempTargetFile>$(_DCAppHostTempTargetDirectory)apphost.exe</_DCAppHostTempTargetFile>
    </PropertyGroup>

    <ItemGroup>
      <_DCAppHostOptionLine Include=">" />
      <_DCAppHostOptionLine Include="AppHostFile" />
      <_DCAppHostOptionLine Include="$(_DCAppHostTempTargetFile)" />
      <_DCAppHostOptionLine Include=">" />
      <_DCAppHostOptionLine Include="DotnetRoot" />
      <_DCAppHostOptionLine Include="$(DCAppHostDotnetRoot)" />
      <_DCAppHostOptionLine Include=">" />
      <_DCAppHostOptionLine Include="HostMissingMessage" />
      <_DCAppHostOptionLine Include="$(DCCoreHostLibMissingDialogMessage)" />
      <_DCAppHostOptionLine Include=">" />
      <_DCAppHostOptionLine Include="HostMissingUrl" />
      <_DCAppHostOptionLine Include="$(DCCoreHostLibMissingDialogUrl)" />
      <_DCAppHostOptionLine Include=">" />
      <_DCAppHostOptionLine Include="NeedPrereqsMessage" />
      <_DCAppHostOptionLine Include="$(DCSystemNeedPrereqsMessage)" />
      <_DCAppHostOptionLine Include=">" />
      <_DCAppHostOptionLine Include="NeedPrereqsUrl" />
      <_DCAppHostOptionLine Include="$(DCSystemNeedPrereqsUrl)" />
      <_DCAppHostOptionLine Include=">" />
    </ItemGroup>

    <WriteLinesToFile File="$(_DCAppHostOptionFilePath)" Lines="@(_DCAppHostOptionLine)" Overwrite="True" />

    <Copy Condition="$(_DCAppHostWillBeChanged)==true" SourceFiles="$(_DCAppHostSourceFile)" DestinationFiles="$(_DCAppHostTempTargetFile)" />
    <Exec Condition="$(_DCAppHostWillBeChanged)==true" Command="$(_DCAppHostPatcherTool) --options $(_DCAppHostOptionFilePath)"
          IgnoreExitCode="false">
      <Output TaskParameter="ExitCode" PropertyName="_DCAppHostPatcherExitCode" />
    </Exec>

    <PropertyGroup Condition="$(_DCAppHostWillBeChanged)==true">
      <AppHostSourcePath>$(_DCAppHostTempTargetFile)</AppHostSourcePath>
    </PropertyGroup>

  </Target>

</Project>